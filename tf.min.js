var TopFriends={isOwner:false,updatedActivity:false,init:function(){TopFriends.Tabs.init();TopFriends.Dialog.init();TopFriends.Friends.init()},log:function(a,b){if(typeof b==="function"){b.apply(console,a)}else{if(typeof console==="object"&&typeof console.log!=="undefined"){console.log.apply(console,arguments)}}},info:function(){if(typeof console==="object"&&typeof console.info!=="undefined"){TopFriends.log(arguments,console.info)}else{TopFriends.log(arguments)}},warn:function(){if(typeof console==="object"&&typeof console.warn!=="undefined"){TopFriends.log(arguments,console.warn)}else{TopFriends.log(arguments)}},error:function(){if(typeof console==="object"&&typeof console.error!=="undefined"){TopFriends.log(arguments,console.error)}else{TopFriends.log(arguments)}}};TopFriends.Common={generateButton:function(a,c){var b=$('<button type="button"></button>');b.addClass("ui-state-default ui-corner-all");b.text(a).click(function(){$(this).removeClass("ui-state-focus");c.apply(this,arguments)});b.hover(function(){$(this).addClass("ui-state-hover")},function(){$(this).removeClass("ui-state-hover")});b.focus(function(){$(this).addClass("ui-state-focus")});b.blur(function(){$(this).removeClass("ui-state-focus")});return b}};TopFriends.Dialog={friendTemplate:'<li><div class="bd"><div class="ib"><img src="#{imgSrc}"></div><div class="tb"><h3>#{name}</h3></div></div></li>',open:function(){TopFriends.Dialog.dialog.dialog("open")},emptyFriendList:function(){$(".friend-list ul li",TopFriends.Dialog.dialog).remove()},addFriend:function(b,a,e,c){a+="&width=48";var d=$(TopFriends.Dialog.friendTemplate.replace(/#\{imgSrc\}/g,a).replace(/#\{name\}/g,b));d.data("name",b).data("avatarUrl",a).data("profileUrl",c).data("id",e);$(".bd",d).addClass("ui-state-default ui-corner-bottom").click(function(){$("#friend-dialog .bd").removeClass("ui-state-active");$(this).addClass("ui-state-active")}).hover(function(){$(this).addClass("ui-state-hover")},function(){$(this).removeClass("ui-state-hover")}).focus(function(){$(this).addClass("ui-state-focus")}).blur(function(){$(this).removeClass("ui-state-focus")});$(".friend-list ul",TopFriends.Dialog.dialog).append(d)},updateFriendListPagination:function(b,a){if(typeof(a)==="undefined"){TopFriends.Dialog.nextButton.unbind("click").addClass("ui-state-disabled")}else{TopFriends.Dialog.nextButton.unbind("click").bind("click",a).removeClass("ui-state-disabled")}if(typeof(b)==="undefined"){TopFriends.Dialog.prevButton.unbind("click").addClass("ui-state-disabled")}else{TopFriends.Dialog.prevButton.unbind("click").bind("click",b).removeClass("ui-state-disabled")}},init:function(){TopFriends.Dialog.dialog=$("#friend-dialog").dialog({height:330,width:600,autoOpen:false,bgiframe:true,resizable:false,modal:true,buttons:{Ok:function(){var a=$("li:has(.ui-state-active)",this);TopFriends.Tabs.addFriend(a.data("name"),a.data("avatarUrl"),a.data("id"),a.data("profileUrl"));$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},close:function(){$(".bd",this).removeClass("ui-state-active")}});TopFriends.Dialog.saveDialog=$("#save-dialog").dialog({height:150,width:300,autoOpen:false,bgiframe:true,resizable:false,modal:true,buttons:{Ok:function(){$(this).dialog("close")}}});TopFriends.Dialog.nextButton=TopFriends.Common.generateButton("Next");TopFriends.Dialog.prevButton=TopFriends.Common.generateButton("Previous");$(".header",TopFriends.Dialog.dialog).append(TopFriends.Dialog.prevButton).append(TopFriends.Dialog.nextButton);$(".bd").addClass("ui-state-default ui-corner-bottom").click(function(){$("#friend-dialog .bd").removeClass("ui-state-active");$(this).addClass("ui-state-active")}).hover(function(){$(this).addClass("ui-state-hover")},function(){$(this).removeClass("ui-state-hover")}).focus(function(){$(this).addClass("ui-state-focus")}).blur(function(){$(this).removeClass("ui-state-focus")})}};TopFriends.Tabs={tabCounter:0,tabTemplate:'<li><a href="#{href}"><span class="title">#{label}</span></a><span class="ui-tabs-nav-close ui-icon ui-icon-close owners-only">close</span></li>',friendTemplate:'<li><div class="bd"><div class="ib"><a target="_top" href="#{profileUrl}"><img src="#{imgSrc}"></a></div><div class="tb"><h3><a target="_top" href="#{profileUrl}">#{name}</a></h3></div></div><span class="ui-icon ui-icon-close owners-only">close</span></li>',getLastTabIndex:function(){return TopFriends.Tabs.tabs.tabs("length")-1},getFirstTabIndex:function(){return 0},getSelectedPanel:function(){return $("div.ui-tabs-panel:not(.ui-tabs-hide)",TopFriends.Tabs.tabs)},getPanel:function(a){return $("#"+a,TopFriends.Tabs.tabs)},renameSelectedTab:function(a){$(".ui-tabs-selected",TopFriends.Tabs.tabs).find(".title").text(a)},generateRenameSelectedTabHandler:function(a){return function(b){var c=$(a).val();TopFriends.Tabs.renameSelectedTab(c)}},generatePanel:function(a,h){var b;var d;var e;var c;var g;var f;var i;b=a.attr("id");d=$("<div>Title: </div>").addClass("ui-tabs-panel-header ui-widget-header ui-corner-all ui-helper-clearfix owners-only");e="rename-text-"+b;c=TopFriends.Common.generateButton("Rename",TopFriends.Tabs.generateRenameSelectedTabHandler("#"+e));g=$("<input/>").attr({type:"text",id:e,value:h});d.append(g).append(c);a.append(d);f=$("<div></div>").addClass("ui-tabs-panel-body ui-widget-content");f.append("<div class='friend-list'><ul></ul></div>");if(TopFriends.isOwner){f.append("<div class='empty-list'><p>You have not added friends yet. Click <em>Add a Friend</em> below to get started</p></div>")}else{f.append("<div class='empty-list'><p>This application is still being set up. Check back soon!</p></div>")}a.append(f);i=$("<div></div>").addClass("ui-tabs-panel-footer ui-widget-content ui-helper-clearfix owners-only");i.append(TopFriends.Common.generateButton("Save",TopFriends.Friends.saveTabs));i.append(TopFriends.Common.generateButton("Add a Friend",TopFriends.Dialog.open));a.append(i);if(TopFriends.isOwner){$(".owners-only",a).removeClass("owners-only")}return a},addTab:function(c){var a;var b;TopFriends.Tabs.tabCounter+=1;if(typeof c==="undefined"){a="List "+TopFriends.Tabs.tabCounter}else{a=c}b="#tabs-"+TopFriends.Tabs.tabCounter;TopFriends.Tabs.tabs.tabs("add",b,a,TopFriends.Tabs.getFirstTabIndex());return b},tabsselectHandler:function(a,b){if(TopFriends.isOwner&&b.index===TopFriends.Tabs.getLastTabIndex()){TopFriends.Tabs.addTab();return false}},removeSelectedTabHandler:function(b){var a=TopFriends.Tabs.tabs.tabs("option","selected");TopFriends.Tabs.tabs.tabs("disable",TopFriends.Tabs.getLastTabIndex());TopFriends.Tabs.tabs.tabs("remove",a);TopFriends.Tabs.tabs.tabs("select",TopFriends.Tabs.getFirstTabIndex());TopFriends.Tabs.tabs.tabs("enable",TopFriends.Tabs.getLastTabIndex())},tabsaddHandler:function(a,b){if(TopFriends.isOwner){$(".ui-tabs-nav-close",b.tab.parent).removeClass("owners-only").click(TopFriends.Tabs.removeSelectedTabHandler)}TopFriends.Tabs.generatePanel($(b.panel),$(".title",b.tab).text());TopFriends.Tabs.tabs.tabs("select",b.index)},addFriend:function(b,a,f,d,c){a+="&width=48";var e=$(TopFriends.Tabs.friendTemplate.replace(/#\{imgSrc\}/g,a).replace(/#\{name\}/g,b).replace(/#\{profileUrl\}/g,d));e.data("name",b).data("avatarUrl",a).data("profileUrl",d).data("id",f);if(TopFriends.isOwner){$(".ui-icon-close",e).removeClass("owners-only").click(function(){e.remove()})}else{$(".ui-icon-close",e).remove()}if(typeof c==="undefined"){$(".friend-list ul",TopFriends.Tabs.getSelectedPanel()).append(e);$(".empty-list",TopFriends.Tabs.getSelectedPanel()).remove()}else{$(".friend-list ul",TopFriends.Tabs.getPanel(c)).append(e);$(".empty-list",TopFriends.Tabs.getPanel(c)).remove()}gadgets.window.adjustHeight()},getStructure:function(){var b=$(".ui-tabs-nav li a[href^=#tabs]",TopFriends.Tabs.tabs);var a={};b.each(function(e,f){var d=$(f).attr("href")+":has(li)";var g=$(f).text();var c=$(d,TopFriends.Tabs.tabs);if(c.length>0){a[g]=[];$(".friend-list ul li",c).each(function(i,h){a[g].push($(h).data("id"))})}});TopFriends.info("getStructure",a);return a},addPanel:function(c,b){var a=TopFriends.Tabs.addTab(c);TopFriends.Friends.requestFriendList(b,a)},makeSortable:function(){if(TopFriends.isOwner){TopFriends.Tabs.tabs.find(".ui-tabs-nav").sortable({axis:"x",items:"li:not(.disabled)"})}},init:function(){if(!TopFriends.isOwner){$("#tabs li").addClass("owners-only");$("#add").addClass("owners-only")}TopFriends.Tabs.tabs=$("#tabs").tabs({tabTemplate:TopFriends.Tabs.tabTemplate,add:TopFriends.Tabs.tabsaddHandler,select:TopFriends.Tabs.tabsselectHandler,show:gadgets.window.adjustHeight});TopFriends.Friends.getTabs()}};TopFriends.Friends={pageSize:4,handleAllFriendsRequest:function(e){var g=e.get("allFriends").getData();var a;var c;var b;var d;TopFriends.Dialog.emptyFriendList();g.each(function(j){var h=j.getField(opensocial.Person.Field.THUMBNAIL_URL);var k=j.getField(opensocial.Person.Field.PROFILE_URL);var i=j.getDisplayName();var l=j.getId();TopFriends.Dialog.addFriend(i,h,l,k);TopFriends.info("handleAllFriendsRequest:",l,i)});if(g.getOffset()>0){d=Math.floor(g.getOffset()/TopFriends.Friends.pageSize)-1;c=function(){TopFriends.Friends.requestAllFriends(d)}}var f=g.getTotalSize()-g.getOffset()-g.size();if(f>0){b=Math.floor(g.getOffset()/TopFriends.Friends.pageSize)+1;a=function(){TopFriends.Friends.requestAllFriends(b)}}TopFriends.Dialog.updateFriendListPagination(c,a)},requestAllFriends:function(c){var b=opensocial.newDataRequest();var a=opensocial.newIdSpec();var d={};if(typeof(c)==="undefined"){c=0}a.setField(opensocial.IdSpec.Field.USER_ID,opensocial.IdSpec.PersonId.OWNER);a.setField(opensocial.IdSpec.Field.GROUP_ID,opensocial.IdSpec.GroupId.FRIENDS);d[opensocial.DataRequest.PeopleRequestFields.SORT_ORDER]=opensocial.DataRequest.SortOrder.NAME;d[opensocial.DataRequest.PeopleRequestFields.MAX]=TopFriends.Friends.pageSize;d[opensocial.DataRequest.PeopleRequestFields.FIRST]=(c*TopFriends.Friends.pageSize);b.add(b.newFetchPeopleRequest(a,d),"allFriends");b.send(TopFriends.Friends.handleAllFriendsRequest)},handleFriendListRequest:function(a){return function(b){var c=b.get("friendList").getData();c.each(function(f){var d=f.getField(opensocial.Person.Field.THUMBNAIL_URL);var g=f.getField(opensocial.Person.Field.PROFILE_URL);var e=f.getDisplayName();var h=f.getId();TopFriends.info("handleFriendListRequest:",h,e,a);TopFriends.Tabs.addFriend(e,d,h,g,a)})}},requestFriendList:function(a,c){var d=opensocial.newDataRequest();var b=opensocial.newIdSpec();var e={};b.setField(opensocial.IdSpec.Field.USER_ID,a);e[opensocial.DataRequest.PeopleRequestFields.SORT_ORDER]=opensocial.DataRequest.SortOrder.NAME;d.add(d.newFetchPeopleRequest(b,e),"friendList");d.send(TopFriends.Friends.handleFriendListRequest(c))},saveTabs:function(){var b=TopFriends.Tabs.getStructure();var a=gadgets.json.stringify(b);var c=opensocial.newDataRequest();if(TopFriends.isOwner){TopFriends.info("saveTabs:",b,a);c.add(c.newUpdatePersonAppDataRequest(opensocial.IdSpec.PersonId.OWNER,"friendStruct",a));c.send();TopFriends.Dialog.saveDialog.dialog("open")}TopFriends.Friends.updateActivity()},handleGetTabs:function(f){var c=f.get("data");var b=f.get("owner");var a,e,h,g,d;if(!b.hadError()&&!c.hadError()){a=b.getData();e=c.getData();h=e[a.getId()];if(h===undefined||typeof h.friendStruct==="undefined"||h.friendStruct==="{}"){TopFriends.info("No data, adding new tab");TopFriends.Tabs.addTab()}else{d=gadgets.json.parse(h.friendStruct);TopFriends.info("handleGetTabs:",h,d);$.each(d,function(j,i){TopFriends.Tabs.addPanel(j,i)})}}else{TopFriends.error(b.getErrorMessage());TopFriends.error(c.getErrorMessage());return false}},getTabs:function(){var c={};var b=opensocial.newIdSpec();var a=opensocial.newDataRequest();c[opensocial.DataRequest.DataRequestFields.ESCAPE_TYPE]=opensocial.EscapeType.NONE;b.setField(opensocial.IdSpec.Field.USER_ID,opensocial.IdSpec.PersonId.OWNER);a.add(a.newFetchPersonRequest(opensocial.IdSpec.PersonId.OWNER),"owner");a.add(a.newFetchPersonAppDataRequest(b,["friendStruct"],c),"data");a.send(TopFriends.Friends.handleGetTabs)},verifyOwnerHandler:function(b){var c;var a=b.get("viewer");if(!a.hadError()){c=a.getData();if(c.isOwner()){TopFriends.isOwner=true;TopFriends.Tabs.makeSortable();$(".owners-only").removeClass("owners-only")}}},verifyOwner:function(){var b={};var a=opensocial.newDataRequest();a.add(a.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER,b),"viewer");a.send(TopFriends.Friends.verifyOwnerHandler)},postActivity:function(c){var b={};b[opensocial.Activity.Field.TITLE]=c;var a=opensocial.newActivity(b);opensocial.requestCreateActivity(a,opensocial.CreateActivityPriority.HIGH);TopFriends.info("postActivity:",c)},updateActivityHandler:function(d){var b,a,f,e;var c=d.get("viewer");if(!c.hadError()){e=c.getData();if(e.isOwner()){b=e.getField(opensocial.Person.Field.PROFILE_URL);a=e.getDisplayName();f='<a href="'+b+'">'+a+"</a> updated their Top Friends";TopFriends.Friends.postActivity(f)}}},updateActivity:function(){var b={};var a=opensocial.newDataRequest();if(!TopFriends.updatedActivity){TopFriends.updatedActivity=true;a.add(a.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER,b),"viewer");a.send(TopFriends.Friends.updateActivityHandler)}},init:function(){TopFriends.Friends.requestAllFriends()}};if(!NING){var NING={}}if(!NING.skinning){NING.skinning={}}NING.skinning=(function(){var b=gadgets.skins.getProperty(gadgets.skins.Property.BG_COLOR);var a=gadgets.skins.getProperty(gadgets.skins.Property.FONT_COLOR);var c=gadgets.skins.getProperty(gadgets.skins.Property.ANCHOR_COLOR);return{updateCSS:function(){var k="a";var d="body, .ui-widget-content";var n=".ui-widget-content, .ui-widget-header, li.ui-state-active, li.ui-state-default, li.ui-state-hover";var l="body, div, p, .newsfeed_box .newsfeed .dateline span";var i=".ui-state-default, .ui-widget-content .ui-state-default, .ui-state-default span";var g=".ui-state-active, .ui-widget-content .ui-state-active";var m=".friend-list .ui-state-default";var j=".friend-list .ui-state-active";var h=".friend-list .ui-state-default h3";var f=".friend-list .ui-state-active h3";var e='<style type="text/css">';e+=k+"{color:"+c+" !important;}";e+=d+"{background-color: "+b+" !important; border-color: "+c+" !important;}";e+=n+"{border-color: "+c+" !important;}";e+=l+"{color: "+a+" !important;}";e+=i+"{border-color: "+c+" !important; color: "+b+" !important; background-color: "+c+";}";e+=g+"{color: "+c+"; background-color: "+b+";}";e+=j+"{border-color: "+c+" !important; color: "+b+" !important; background-color: "+c+" !important;}";e+=m+"{color: "+c+"; background-color: "+b+";}";e+=f+"{color: "+b+" !important;}";e+=h+"{color: "+c+";}";e+="</style>";$("head").append(e)}}}());